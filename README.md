# Surf Calendar MVP - הרצליה

מערכת אוטומטית שמתחברת ל-Storm Glass API, מנתחת תחזיות גלישה להרצליה, ויוצרת אירועים בלוח שנה ציבורי בגוגל קלנדר עבור חלונות גלישה איכותיים.

## מטרת ה-MVP

יצירת לוח שנה ציבורי אחד שמנהל קהילת גולשים בהרצליה. הנחת היסוד: "האם גולשים יאמצו החלטות גלישה מבוססות לוח שנה?"

**חשוב:** כל הטקסט המוצג למשתמשים הוא בעברית בלבד.

## מה ה-MVP הזה כן עושה
- ✅ מנהל לוח שנה ציבורי אחד להרצליה
- ✅ לוח השנה הוא לקריאה בלבד (משתמשים מתחברים דרך קישור)
- ✅ כל האירועים בבעלות חשבון השירות
- ✅ **רק** אירועי גלישה טובה - אין אירועי "אין גלים" או סטטוס
- ✅ **כל הטקסט בעברית**

## מה ה-MVP הזה לא עושה
- ❌ אין אימות משתמשים או חשבונות
- ❌ אין אתר או ממשק משתמש
- ❌ אין בסיס נתונים (לוח השנה הוא מקור האמת)
- ❌ אין התאמה אישית או העדפות משתמש
- ❌ אין התראות, התראות או ערוצי תקשורת
- ❌ אין אירועי "אין גלים" או התראות סטטוס

## לוגיקת יצירת אירועים

### תנאי גלישה טובה
אירוע נוצר **רק אם** כל התנאים הבאים מתקיימים:
- גובה גלים: 0.8מ' - 2.5מ'
- תקופת גלים: ≥7 שניות
- מהירות רוח: <15 קשר
- כיוון רוח: חוף או חצי-חוף להרצליה (רוחות מערביות בדרך כלל חופיות)

### מבנה אירוע
- **כותרת:** "🌊 חלון גלישה - [רמת קושי]" (כולל emoji ורמת קושי)
- **תאריך:** אירוע אחד לכל היותר ליום
- **שעה:**
  - המערכת מוצאת את השעה הטובה ביותר ביום (ציון איכות הגבוה ביותר)
  - יוצרת חלון של 3 שעות סביב השעה הזו (שעה לפני + שעתיים אחרי)
  - מתאימה את החלון לשעות הגלישה היומיות (06:00-18:00)
- **תיאור (עברית):** תבנית עם נתונים והמלצות:

```
🌊 חלון גלישה - אידיאלי

נתונים:
• גובה גל: 1.2 מטר (3.9 פיט)
• תקופה: 8 שניות
• רוח: צפון-מערב 5 קשר (offshore)

תנאים מצוינים! גובה גל אידיאלי לרוב הגולשים
מתאים ל: כל הרמות

• תחזית נכון ל-: 15.01.2026, 08:00

תחזית אוטומטית. התנאים עשויים להשתנות.
יש לבדוק את מצב הים בשטח.
```

כיווני רוח בעברית: צפון (N), דרום (S), מזרח (E), מערב (W), צפון-מזרח (NE), דרום-מזרח (SE), דרום-מערב (SW), צפון-מערב (NW)

## שכלול נתוני תחזית
המערכת **משכללת את כל ספקי התחזית** (DWD, ECMWF, METEO, NOAA, SG) באמצעות ממוצע משוקלל, במקום להשתמש בערך בודד מספק אחד. זה מבטיח דיוק רב יותר בתחזית התנאים.

**ספקי התחזית:**
- **DWD** - שירות מזג האוויר הגרמני
- **ECMWF** - מרכז אירופי לתחזיות מזג אוויר
- **METEO** - מזג האוויר הצרפתי
- **NOAA** - מנהל האוקיינוס והאטמוספירה הלאומי (ארה"ב)
- **SG** - Storm Glass עצמו

## מחזור חיי אירועים (קריטי)

### כלל 1: יצירה
- צור אירוע **רק אם** התנאים עומדים בסף האיכות
- מקסימום אירוע אחד ליום
- **אל תיצור** אירועי "אין גלים" או סטטוס

### כלל 2: עדכון (תנאים עדיין טובים)
- אם אירוע כבר קיים ליום **והתנאים עדיין טובים** → עדכן את האירוע בנתוני תחזית חדשים
- שמור כותרת כ-"חלון גלישה טוב - הרצליה"

### כלל 3: הידרדרות
- אם אירוע קיים ליום **והתנאים ירדו מתחת לסף**:
  - **מחק** את האירוע
  - הסיבה: כשהתנאים מתדרדרים, זמני האירוע המקוריים עלולים להיות מחוץ לשעות הגלישה היומיות (06:00-18:00)
  - טוב יותר למחוק ולתת למערכת ליצור אירוע חדש אם התנאים ישתפרו מאוחר יותר

### כלל 4: אין אירוע
- אם אין אירוע ליום **והתנאים מתחת לסף** → אל תעשה כלום (שקט = לא טוב)

**עיקרון בסיסי:** אירועים מייצגים "מצאנו חלון טוב". כאשר התנאים טובים - נוצר אירוע חדש. כאשר התנאים מידרדרים - האירוע נמחק. המערכת תמיד מחפשת את השעה הטובה ביותר ביום ויוצרת חלון של 3 שעות סביבה.

## טווח תחזית ועדכונים
- צור/עדכן אירועים לחלון גלילה של **48 שעות** (היום + מחר בלבד)
- הפעל את האוטומציה **כל 6 שעות** (00:00, 06:00, 12:00, 18:00 שעון ישראל)
- **אל תיצור** אירועים מעבר ל-48 שעות (דיוק תחזית יורד)

## ניהול אירועים ואידמפוטנטיות
- לפני יצירת אירוע, בדוק אם כבר קיים אירוע ליום הספציפי
- השתמש במטא-דאטה של אירוע או תקציר אירוע + תאריך לזיהוי אירועים מנוהלים
- עדכן אירועים קיימים כאשר התנאים עדיין טובים (מניעת כפילויות)
- מחק אירועים כאשר התנאים מתדרדרים (מניעת זמנים לא תקפים)
- אירועים נעלמים באופן טבעי כשהתאריך שלהם עובר (אין ניקוי ידני נדרש)

## טיפול בשגיאות ולוגים
- רשום כל ריצות אוטומציה עם חותמת זמן ותוצאה
- פורמט לוג: "[חותמת זמן] Checked forecast for [תאריך]. Result: [Created|Updated|Degraded|No Action]. Conditions: [סיכום]"
- אם Storm Glass API נכשל: רשום שגיאה, **אל תשנה** אירועים קיימים, נסה שוב בריצה הבאה
- אם Google Calendar API נכשל: רשום שגיאה, נסה שוב עם backoff אקספוננציאלי (מקסימום 3 ניסיונות)
- אם כשלים חוזרים (3+ ריצות): רשום באופן בולט

## הגדרות

ניתן להגדיר דרך משתני סביבה:
- `GOOGLE_CALENDAR_ID` (מזהה לוח השנה מגוגל)
- `GOOGLE_SERVICE_ACCOUNT_KEY` (נתיב לקובץ credentials JSON)
- `STORMGLASS_API_KEY`
- `HERZLIYA_LAT` (ברירת מחדל: 32.1667)
- `HERZLIYA_LON` (ברירת מחדל: 34.8000)
- ספי איכות:
  - `MIN_WAVE_HEIGHT`: 0.8 (מטר)
  - `MAX_WAVE_HEIGHT`: 2.5 (מטר)
  - `MIN_WAVE_PERIOD`: 7 (שניות)
  - `MAX_WIND_SPEED`: 15 (קשר)
- חלונות זמן:
  - `MORNING_START`: 06:00
  - `MORNING_END`: 10:00
  - `EVENING_START`: 16:00
  - `EVENING_END`: 19:00
- `TIMEZONE`: Asia/Jerusalem
- `FORECAST_HORIZON_HOURS`: 48

## התקנה והרצה

### 1. התקנת תלויות
```bash
npm install
```

### 2. הגדרת משתני סביבה
```bash
cp .env.template .env
# ערוך את .env עם הערכים שלך
```

### 3. הרצה ידנית לבדיקה
```bash
npm start
```

### 4. הרצת בדיקה יבשה (מראה מה היה קורה בלי ליצור אירועים)
```bash
npm run dry-run
```

### 5. פריסה כמשימה מתוזמנת
הוסף ל-cron job שרץ כל 6 שעות:
```bash
0 */6 * * * cd /path/to/surf-calendar && npm start
```

## רשימת בדיקות לפני הפריסה
- [ ] יכול ליצור אירוע חדש כשתנאים טובים (בעברית עם רמת קושי ו-emoji)
- [ ] יכול לעדכן אירוע קיים "טוב" בנתוני תחזית חדשים
- [ ] מוחק אירוע כשתנאים מתדרדרים (מניעת זמנים לא תקפים)
- [ ] **לא** יוצר אירועים כפולים לאותו יום
- [ ] **לא** יוצר אירועים כשתנאים מתחת לסף
- [ ] **לא** יוצר אירועי "אין גלים"
- [ ] מטפל בכשלי API בצורה חלקה (רושם שגיאה, לא קורס)
- [ ] מכבד טווח תחזית של 48 שעות
- [ ] כל טקסט אירוע בעברית
- [ ] עיצוב תאריך/שעה נכון לאזור ישראל
- [ ] מזהה תנאי גלישה ישראליים (גלים קצרים עם גובה בינוני)
- [ ] כולל המלצות לפי רמת קושי (מתחילים/אידיאלי/מתקדמים/קיצוני)
- [ ] ממליץ על מרינה הרצליה בתנאים קיצוניים עם רוח דרומית

## טכנולוגיות
- Node.js
- Storm Glass API (תחזיות ימיות)
- Google Calendar API עם service account
- axios (בקשות HTTP)
- dotenv (משתני סביבה)

## רישיון
פרויקט ניסיוני ללימוד - 2 שבועות

---

## הערות חשובות
לוח השנה הזה ישותף בקבוצות וואטסאפ של גולשים בהרצליה. קהל היעד: אנשי מקצוע עובדים שרוצים לתכנן את השבוע שלהם סביב גלישה.

**אמון הוא הכל:** שבוע אחד של תחזיות שגויות יהרוג את האימוץ. סף שמרני טוב יותר מתקיף.

**שקט הוא תכונה:** אין אירועים ל-5 ימים אומר שהתנאים לא היו טובים. גולשים יאמינו יותר בלוח השנה כי הוא בררן.
```

---

**שמור את הקובץ ו-README מעודכן!** 📝